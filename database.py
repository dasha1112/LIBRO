import pandas as pd
import json
from typing import Dict, List, Optional
from dataclasses import dataclass, field
import streamlit as st

@dataclass
class Book:
    """Класс книги с расширенными атрибутами"""
    id: int
    title: str
    author: str
    main_genre: str
    sub_genre: str
    rating: float
    year: int
    pages: int
    description: str
    cover_image: str
    
    # Базовые атрибуты
    tags: List[str] = field(default_factory=list)
    
    # Детальные атрибуты (подтемы)
    character_age: Optional[str] = None
    character_profession: Optional[str] = None
    character_gender: Optional[str] = None
    
    setting_time_period: Optional[str] = None
    setting_location: Optional[str] = None
    setting_type: Optional[str] = None  # город, деревня, космос и т.д.
    
    plot_tropes: List[str] = field(default_factory=list)
    mood: List[str] = field(default_factory=list)
    pacing: Optional[str] = None  # медленный, средний, быстрый
    
    # Дополнительные категории
    themes: List[str] = field(default_factory=list)  # любовь, дружба, предательство
    style: List[str] = field(default_factory=list)   # поэтичный, простой, сложный

@dataclass
class Review:
    """Класс рецензии"""
    id: int
    book_id: int
    username: str
    rating: int
    text: str
    created_at: str
    likes: int = 0

class BookDatabase:
    """База данных книг и отзывов"""
    
    def __init__(self):
        self.books = self._create_sample_books()
        self.reviews = self._create_sample_reviews()
        self.user_lists = {}  # {username: {list_name: [book_ids]}}

    def get_user_reviews_from_manager(self, username: str, book_page_manager) -> pd.DataFrame:
        """Получение отзывов пользователя из book_page_manager"""
        all_reviews = book_page_manager.reviews  # Это словарь {book_id: [reviews]}
        
        user_reviews_list = []
        for book_id, reviews in all_reviews.items():
            for review in reviews:
                if review["username"] == username:
                    # Добавляем информацию о книге
                    book_info = self.books[self.books["id"] == int(book_id)]
                    if not book_info.empty:
                        book_title = book_info.iloc[0]["title"]
                        book_author = book_info.iloc[0]["author"]
                    else:
                        book_title = f"Книга ID: {book_id}"
                        book_author = "Неизвестный автор"
                    
                    user_reviews_list.append({
                        "id": review["id"],
                        "book_id": int(book_id),
                        "username": review["username"],
                        "rating": review["rating"],
                        "text": review["text"],
                        "created_at": review["date"],
                        "likes": review.get("likes", 0),
                        "book_title": book_title,
                        "book_author": book_author
                    })
        
        return pd.DataFrame(user_reviews_list)
    
    def _create_sample_books(self) -> pd.DataFrame:
        """Создание демонстрационной базы книг с иерархией жанров"""
        base_image_path = "images/"
        books_data = [
        {
            "id": 1,
            "title": "Мастер и Маргарита",
            "author": "Михаил Булгаков",
            "main_genre": "Классика",
            "sub_genre": "Магический реализм",
            "rating": 4.8,
            "year": 1966,
            "pages": 480,
            "description": "Жарким майским вечером председатель правления МАССОЛИТ Михаил Берлиоз и молодой поэт Иван Бездомный отправились на Патриаршие пруды, чтобы обсудить: существовал ли Иисус Христос. Беседой литераторов заинтересовался некий импозантный гражданин-иностранец. Профессор Воланд стал уверять новых знакомых, что лично присутствовал на допросе бродяги Иешуа Га-Ноцри, который проводил Понтий Пилат.\
            Александр Берлиоз и Иван Бездомный сочли собеседника сумасшедшим. А зря. Ведь через несколько часов Берлиоз попал под трамвай, а Иван отправился в сумасшедший дом, где и познакомился с мастером – возлюбленным Маргариты, будущей королевой бала у сатаны. Поэт узнает, что именно из-за романа о Понтии Пилате мастер оказался в сумасшедшем доме, а сама рукопись принесла писателю страшные несчастья…\
            Тем временем Воланд со свитой весьма необычным образом исследуют, как изменились москвичи за последние годы. Это исследование надолго останется в памяти тех, кому довелось столкнуться с происками дьявола и его помощников, обладающих специфическим чувством юмора и особым взглядом на справедливость и милосердие…",
            "cover_image": f"{base_image_path}book_1.png",
            "tags": ["мистика", "Москва", "дьявол", "любовь", "сатира"],
            "character_age": "30-40",
            "character_gender": "оба пола",
            "character_profession": "писатель",
            "setting_time_period": "1930-е годы",
            "setting_location": "Москва",
            "setting_type": "город",
            "plot_tropes": ["договор с дьяволом", "борьба добра и зла"],
            "mood": ["мистическое", "философское"],
            "pacing": "неравномерный",
            "themes": ["добро и зло", "творчество"],
            "style": ["сложный", "символический"]
        },
        {
            "id": 2,
            "title": "Сто лет одиночества",
            "author": "Габриэль Гарсия Маркес",
            "main_genre": "Классика",
            "sub_genre": "Магический реализм",
            "rating": 4.6,
            "year": 1967,
            "pages": 416,
            "description": "Странная, поэтичная, причудливая история города Макондо, затерянного где-то в джунглях, – от сотворения до упадка.\
            История рода Буэндиа – семьи, в которой чудеса столь повседневны, что на них даже не обращают внимания.\
            Клан Буэндиа порождает святых и грешников, революционеров, героев и предателей, лихих авантюристов – и женщин, слишком прекрасных для обычной жизни.\
            В нем кипят необычайные страсти, и происходят невероятные события.\
            Однако эти невероятные события снова и снова становятся своеобразным «волшебным зеркалом», сквозь которое слушателю является подлинная история Латинской Америки…",
            "cover_image": f"{base_image_path}book_2.jpg",
            "tags": ["семейная сага", "магия", "одиночество", "Латинская Америка"],
            "character_age": "40 - 50",
            "character_gender": "мужчина",
            "character_profession": "разные",
            "setting_time_period": "XIX-XX века",
            "setting_location": "Колумбия",
            "setting_type": "изолированный город",
            "plot_tropes": ["семейная сага", "цикличность", "пророчество"],
            "mood": ["поэтическое", "мифическое"],
            "pacing": "плавный",
            "themes": ["одиночество", "время", "любовь"],
            "style": ["магический реализм", "поэтический"]
        },
        {
            "id": 3,
            "title": "Убийство в Восточном экспрессе",
            "author": "Агата Кристи",
            "main_genre": "Детектив",
            "sub_genre": "Классический детектив",
            "rating": 4.8,
            "year": 1934,
            "pages": 256,
            "description": "Трансъевропейский экспресс оказывается в снежном плену на пути следования из Стамбула в Кале. Сильный снегопад вынуждает машиниста остановить поезд в поле. Между тем в одном из купе обнаруживают тело убитого американца. За расследование убийства берётся необычный пассажир, знаменитый бельгийский детектив Эркюль Пуаро.",
            "cover_image": f"{base_image_path}book_3.jpg",
            "tags": ["поезд", "убийство", "расследование", "Пуаро"],
            "character_age": "40-50",
            "character_gender": "мужчина",
            "character_profession": "детектив",
            "setting_time_period": "1930-е годы",
            "setting_location": "Поезд",
            "setting_type": "поезд",
            "plot_tropes": ["закрытое пространство", "расследование"],
            "mood": ["интригующее", "логическое"],
            "pacing": "средний",
            "themes": ["правосудие", "логика", "преступление"],
            "style": ["классический", "детективный"]
        },
        {
            "id": 4,
            "title": "Десять негритят",
            "author": "Агата Кристи",
            "main_genre": "Детектив",
            "sub_genre": "Детектив-головоломка",
            "rating": 4.9,
            "year": 1939,
            "pages": 320,
            "description": "Некто приглашает десять гостей в особняк, расположенный на уединённом острове. Эти люди незнакомы друг с другом, у них нет ничего общего: разные профессии, социальный статус и жизненный опыт. Впрочем, главному режиссёру последующих событий известно, что у каждого из них в биографии есть страницы, о которых они предпочли бы забыть. Однако прошлое настигает их в образе невидимого убийцы, вершащего свой суд на преступниками, которые сумели избежать правосудия. Гости особняка один за другим погибают, повторяя судьбу героев известной считалочки про десять негритят… «И никого не стало».",
            "cover_image": f"{base_image_path}book_4.jpg",
            "tags": ["остров", "убийство", "тайна", "изоляция"],
            "character_age": "20-40",
            "character_gender": "оба пола",
            "character_profession": "разные",
            "setting_time_period": "1930-е годы",
            "setting_location": "Остров",
            "setting_type": "изолированный остров",
            "plot_tropes": ["закрытое пространство", "поэтапные убийства"],
            "mood": ["зловещее", "параноидальное"],
            "pacing": "нарастающий",
            "themes": ["вина", "возмездие", "смерть"],
            "style": ["классический", "напряженный"]
        },
        {
            "id": 5,
            "title": "1984",
            "author": "Джордж Оруэлл",
            "main_genre": "Антиутопия",
            "sub_genre": "Политическая проза",
            "rating": 4.6,
            "year": 1949,
            "pages": 320,
            "description": "Лондон, 1984-й год. Бывшая Великобритания является крупной провинцией Океании – государства с жесточайшим тоталитарным строем. Его жители лишены не только основных гражданских прав, но и какой бы то ни было индивидуальности. В партийном обществе, возглавляемом невидимым, но всевидящим Большим Братом, царят пуританские взгляды, запрещающие половые связи и любовные отношения, а также мощная пропаганда ненависти по отношению к внешним врагам – государствам Евразии и Остазии.\
            Уинстон Смит, работающий в Министерстве Правды, ощущает глубинное внутреннее сопротивление политике партии, к которой принадлежит. Он сомневается абсолютно во всем и, чтобы разобраться в своих чувствах, начинает вести личный дневник, что уже само по себе является преступлением. А вскоре Уинстон осмеливается пойти на куда более опасный шаг, поддавшись романтическим чувствам к сотруднице по имени Джулия.",
            "cover_image": f"{base_image_path}book_5.jpg",
            "tags": ["тоталитаризм", "контроль", "бунт", "будущее"],
            "character_age": "30-40",
            "character_gender": "мужчина",
            "character_profession": "госслужащий",
            "setting_time_period": "Будущее",
            "setting_location": "Лондон",
            "setting_type": "город-государство",
            "plot_tropes": ["тотальный контроль", "бунт личности"],
            "mood": ["мрачное", "тревожное"],
            "pacing": "напряженный",
            "themes": ["свобода и контроль", "истина и ложь"],
            "style": ["холодный", "аллегорический"]
        },
        {
            "id": 6,
            "title": "О дивный новый мир",
            "author": "Олдос Хаксли",
            "main_genre": "Антиутопия",
            "sub_genre": "Научная фантастика",
            "rating": 4.5,
            "year": 1932,
            "pages": 288,
            "description": "«О дивный новый мир» – изысканная и остроумная антиутопия о генетически программируемом «обществе потребления», в котором разворачивается трагическая история Дикаря – «Гамлета» этого мира.",
            "cover_image": f"{base_image_path}book_6.jpg",
            "tags": ["будущее", "генетика", "контроль", "удовольствие"],
            "character_age": "20-30",
            "character_gender": "мужчина",
            "character_profession": "специалист",
            "setting_time_period": "Будущее",
            "setting_location": "Лондон",
            "setting_type": "футуристическое общество",
            "plot_tropes": ["идеальное общество", "диссидент", "прогресс"],
            "mood": ["ироничное", "тревожное"],
            "pacing": "размеренный",
            "themes": ["свобода воли", "технологии", "счастье"],
            "style": ["сатирический", "философский"]
        },
        {
            "id": 7,
            "title": "Дюна",
            "author": "Фрэнк Герберт",
            "main_genre": "Фантастика",
            "sub_genre": "Планетарный роман",
            "rating": 4.7,
            "year": 1965,
            "pages": 704,
            "description": "Действие романа происходит в далеком будущем, посреди разросшейся феодальной межгалактической империи, где планетарные вотчины контролируются благородными семействами, верными Императорскому дому Коррино.\
            В центре повествования – молодой Пол Атрейдес, наследник герцога Лето Атрейдеса. Семья переезжает на планету Арракис, единственный во вселенной источник пряностей-меланжа. Автор создает масштабное полотно, где отображены сложные политические, религиозные, экологические, технологические вопросы. Здесь тесно переплетаются судьбы самого Пола, его семьи, коренных жителей Арракиса, Императора, могущественных гильдий и орденов. Великое противостояние сильных мира сего ведет к глобальным переменам, которые затронут все человечество.",
            "cover_image": f"{base_image_path}book_7.jpg",
            "tags": ["космос", "политика", "пустыня", "мессия", "экология"],
            "character_age": "20-30",
            "character_gender": "мужчина",
            "character_profession": "наследник",
            "setting_time_period": "Будущее",
            "setting_location": "Другая планета",
            "setting_type": "пустынная планета",
            "plot_tropes": ["мессианский сюжет", "политический заговор"],
            "mood": ["эпическое", "философское"],
            "pacing": "медленный",
            "themes": ["власть и религия", "экология", "судьба"],
            "style": ["эпический", "политический"]
        },
        {
            "id": 8,
            "title": "Автостопом по галактике",
            "author": "Дуглас Адамс",
            "main_genre": "Фантастика",
            "sub_genre": "Космическая комедия",
            "rating": 4.7,
            "year": 1979,
            "pages": 224,
            "description": "Дом Артура Дента пытаются снести, чтоб построить новую трассу. Артур пытается остановить снос, но тут выясняется, что его друг – пришелец с другой планеты, а Землю вот-вот уничтожат, чтобы построить гиперпространственную магистраль. Давно ставшая культовой смешная, сатирическая и глубокая книга с иллюстрациями британского иллюстратора Криса Ридделла.",
            "cover_image": f"{base_image_path}book_8.jpg",
            "tags": ["космос", "комедия", "путешествия", "абсурд"],
            "character_age": "20-30",
            "character_gender": "мужчина",
            "character_profession": "низший клерк",
            "setting_time_period": "Будущее",
            "setting_location": "Космос",
            "setting_type": "космические корабли",
            "plot_tropes": ["неудачливый герой", "космические приключения"],
            "mood": ["абсурдное", "ироничное"],
            "pacing": "быстрый",
            "themes": ["абсурдность бытия", "технологии", "дружба"],
            "style": ["ироничный", "абсурдистский"]
        },
        {
            "id": 9,
            "title": "Гарри Поттер и философский камень",
            "author": "Джоан Роулинг",
            "main_genre": "Фэнтези",
            "sub_genre": "Героическое фэнтези",
            "rating": 4.9,
            "year": 1997,
            "pages": 400,
            "description": "«Гарри Поттер и философский камень» — первая книга фэнтезийной саги Джоан Роулинг, рассказывающая о сироте Гарри Поттере, который в свой 11-й день рождения узнаёт, что он волшебник, и отправляется в Школу Чародейства и Волшебства Хогвартс, где обретает друзей, учится магии и раскрывает тайну загадочного камня, который пытается украсть возродившийся злой волшебник Волан-де-Морт, убивший родителей Гарри",
            "cover_image": f"{base_image_path}book_9.jpg",
            "tags": ["волшебство", "школа", "дружба", "сирота"],
            "character_age": "0-18",
            "character_gender": "мужчина",
            "character_profession": "ученик",
            "setting_time_period": "1990-е годы",
            "setting_location": "Школа магии",
            "setting_type": "магическая школа",
            "plot_tropes": ["избранный герой", "тайное происхождение"],
            "mood": ["приключенческое", "чудесное"],
            "pacing": "динамичный",
            "themes": ["добро против зла", "дружба", "взросление"],
            "style": ["увлекательный", "детальный"]
        },
        {
            "id": 10,
            "title": "Властелин колец: Братство кольца",
            "author": "Дж. Р. Р. Толкин",
            "main_genre": "Фэнтези",
            "sub_genre": "Эпическое фэнтези",
            "rating": 4.9,
            "year": 1954,
            "pages": 432,
            "description": "«Властелин колец: Братство кольца» — это начало эпической фэнтези-саги о хоббите Фродо Бэггинсе, которому предстоит уничтожить Кольцо Всевластья, выкованное Тёмным Властелином Сауроном, чтобы спасти Средиземье от порабощения, отправившись в опасное путешествие в Мордор вместе с разношёрстным Братством эльфов, гномов, людей и хоббитов, где главное — борьба добра и зла и испытание дружбы",
            "cover_image": f"{base_image_path}book_10.png",
            "tags": ["кольцо", "путешествие", "битвы", "Средиземье"],
            "character_age": "20-30",
            "character_gender": "мужчина",
            "character_profession": "хоббит",
            "setting_time_period": "Мифическое прошлое",
            "setting_location": "Вымышленный мир",
            "setting_type": "вымышленный мир",
            "plot_tropes": ["опасное путешествие", "борьба добра и зла"],
            "mood": ["эпическое", "героическое", "мрачное"],
            "pacing": "медленный",
            "themes": ["дружба", "жертва", "власть", "война"],
            "style": ["эпический", "мифологический"]
        },
        {
            "id": 11,
            "title": "Три товарища",
            "author": "Эрих Мария Ремарк",
            "main_genre": "Классика",
            "sub_genre": "Военная проза",
            "rating": 4.7,
            "year": 1936,
            "pages": 480,
            "description": "Трое друзей - Робби, отчаянный автогонщик Кестер и 'последний романтик' Лени прошли Первую мировую войну. Вернувшись в гражданскую жизнь, они основали небольшую автомастерскую. И хотя призраки прошлого преследуют их, они не унывают - ведь что может быть лучше дружбы, крепкой и верной, ради которой можно отдать последнее? Наверное, лишь только любовь, не знающая границ и пределов. Прекрасная и грустная Пат, нежная возлюбленная Робби, рассеивает мрак бессмысленности его существования. Однако обретенному счастью угрожают отголоски все той же войны - существующие уже не только в памяти и сознании героев, а суровым образом воплотившиеся в реальность...",
            "cover_image": f"{base_image_path}book_11.jpg",
            "tags": ["дружба", "любовь", "потеря", "война"],
            "character_age": "30-40",
            "character_gender": "мужчина",
            "character_profession": "автомеханик",
            "setting_time_period": "1920-е годы",
            "setting_location": "Германия",
            "setting_type": "город",
            "plot_tropes": ["верная дружба", "любовь после потерь"],
            "mood": ["меланхолическое", "трогательное"],
            "pacing": "размеренный",
            "themes": ["посттравматический синдром", "верность"],
            "style": ["лиричный", "психологический"]
        },
        {
            "id": 12,
            "title": "Над пропастью во ржи",
            "author": "Джером Д. Сэлинджер",
            "main_genre": "Классика",
            "sub_genre": "Роман воспитания",
            "rating": 4.3,
            "year": 1951,
            "pages": 240,
            "description": "Мальчика зовут Холден Колфилд, и живет он в повести «Над пропастью во ржи», до сих пор боготворимой миллионами «непонятых» подростков.\
            Холден наделен «абсолютным нравственным слухом» — он мгновенно различает фальшь, с него словно содрана кожа, обнажены нервные окончания, его сверхчувствительность — особого рода радар, улавливающий то, мимо чего спокойно проходят другие. Но он не ангел и не «дитя цветов», а трудный подросток во всей красе: со своими переживаниями, волнениями и талантами, но и со всеми тараканами тоже. К тому же у Холдена есть еще и странная, но очень трогательная мечта...",
            "cover_image": f"{base_image_path}book_12.jpg",
            "tags": ["подросток", "бунт", "одиночество"],
            "character_age": "0-18",
            "character_gender": "мужчина",
            "character_profession": "школьник",
            "setting_time_period": "1940-е годы",
            "setting_location": "Нью-Йорк",
            "setting_type": "город",
            "plot_tropes": ["бунт подростка", "поиск себя"],
            "mood": ["бунтарское", "одинокое"],
            "pacing": "средний",
            "themes": ["взросление", "лицемерие", "изоляция"],
            "style": ["исповедальный", "разговорный"]
        },
        {
            "id": 13,
            "title": "Портрет Дориана Грея",
            "author": "Оскар Уайльд",
            "main_genre": "Классика",
            "sub_genre": "Философский роман",
            "rating": 4.6,
            "year": 1890,
            "pages": 320,
            "description": "Главный герой романа, красавец Дориан, — фигура двойственная, неоднозначная. Тонкий эстет и романтик становится безжалостным преступником. Попытка сохранить свою необычайную красоту и молодость оборачивается провалом. Вместо героя стареет его портрет — но это не может продолжаться вечно, и смерть Дориана расставляет все по своим местам.\
            Роман Оскара Уайльда продолжает быть очень актуальным и сегодня — разве погоня за вечной молодостью порой не оборачивается потерей своего истинного лица?",
            "cover_image": f"{base_image_path}book_13.jpg",
            "tags": ["красота", "разврат", "портрет", "договор"],
            "character_age": "20-30",
            "character_gender": "мужчина",
            "character_profession": "аристократ",
            "setting_time_period": "Викторианская эпоха",
            "setting_location": "Лондон",
            "setting_type": "город",
            "plot_tropes": ["договор с дьяволом", "двойник", "падение"],
            "mood": ["декадентское", "мрачное", "эстетское"],
            "pacing": "средний",
            "themes": ["красота и разложение", "мораль", "искусство"],
            "style": ["эстетский", "афористичный"]
        },
        {
            "id": 14,
            "title": "Метро 2033",
            "author": "Дмитрий Глуховский",
            "main_genre": "Постапокалипсис",
            "sub_genre": "Научная фантастика",
            "rating": 4.5,
            "year": 2005,
            "pages": 384,
            "description": "Постапокалиптический роман о выживании в московской подземке. Ядерная война уничтожила почти все человечество, выжившие скрываются в метро. Москва стала одним из центров скоплений людей, но об организованном выживании речи не идет. Часть станций пришла в негодность сразу после войны, другие поделены между группировками. Каждый выживает, как может, в суровых условиях подземного мрака.\
            Но что еще хуже: в этом мраке обитают «черные» – мутанты, а в спертом воздухе витают пожирающие аномалии. Главный герой Артем попадает в эпицентр необъяснимых событий. Вместе с друзьями он отправляется в путь по опасным тоннелям, где смерть настигает буквально из ниоткуда. Тем, кто останется в живых, предстоит выяснить загадку черных и, возможно, спасти человечество.",
            "cover_image": f"{base_image_path}book_14.jpg",
            "tags": ["постапокалипсис", "метро", "мутанты"],
            "character_age": "20-30",
            "character_gender": "мужчина",
            "character_profession": "военный",
            "setting_time_period": "Будущее",
            "setting_location": "Москва",
            "setting_type": "метро",
            "plot_tropes": ["путешествие героя", "выживание"],
            "mood": ["мрачное", "гнетущее"],
            "pacing": "напряженный",
            "themes": ["выживание", "страх", "человечность"],
            "style": ["атмосферный", "жесткий"]
        },
        {
            "id": 15,
            "title": "Старик и море",
            "author": "Эрнест Хемингуэй",
            "main_genre": "Классика",
            "sub_genre": "Повесть",
            "rating": 4.4,
            "year": 1952,
            "pages": 128,
            "description": "«Старик и море». Повесть посвящена «трагическому стоицизму»: перед жестокостью мира человек, даже проигрывая, должен сохранять мужество и достоинство.\
            Автобиографическая повесть «Зеленые холмы Африки» – одно из произведений, заложивших основу мифа о «папе Хэме» – смелом до безумия авантюристе-интеллектуале, любимце женщин, искателе сильных ощущений и новых впечатлений.",
            "cover_image": f"{base_image_path}book_15.jpg",
            "tags": ["рыбак", "море", "борьба", "одиночество"],
            "character_age": "50-60",
            "character_gender": "мужчина",
            "character_profession": "рыбак",
            "setting_time_period": "1940-е годы",
            "setting_location": "Куба",
            "setting_type": "море",
            "plot_tropes": ["борьба с природой", "нравственная победа"],
            "mood": ["суровое", "философское"],
            "pacing": "медленный",
            "themes": ["человек и природа", "упорство", "достоинство"],
            "style": ["лаконичный", "символический"]
        },
        {
            "id": 16,
            "title": "Анна Каренина",
            "author": "Лев Толстой",
            "main_genre": "Классика",
            "sub_genre": "Роман",
            "rating": 4.7,
            "year": 1877,
            "pages": 864,
            "description": "Классика актуальна в любую историческую эпоху, потому что в ней затронуты темы, близкие лично каждому человеку. И автору не обязательно давать прямые ответы на животрепещущие вопросы; даже лучше эту возможность предоставить читателю. Толстой и не дает их. Напротив, афористично введя нас в курс дела единственным предложением «Все счастливые семьи похожи друг на друга, каждая несчастливая семья несчастлива по-своему», тут же все смешивает, даже не подбирая особых слов: «Все смешалось в доме Облонских». А дальше — дело читателя пройти всеми тропками сюжета с ношей собственного жизненного опыта и самому отыскать эти ответы. У каждого они разные. И это классика.",
            "cover_image": f"{base_image_path}book_16.png",
            "tags": ["любовь", "измена", "общество", "трагедия"],
            "character_age": "20-30",
            "character_gender": "женщина",
            "character_profession": "аристократка",
            "setting_time_period": "XIX век",
            "setting_location": "Россия",
            "setting_type": "город и деревня",
            "plot_tropes": ["любовный треугольник", "падение женщины"],
            "mood": ["трагическое", "драматическое"],
            "pacing": "размеренный",
            "themes": ["любовь и долг", "семья", "общество"],
            "style": ["психологический", "реалистичный"]
        },
        {
            "id": 17,
            "title": "Улисс",
            "author": "Джеймс Джойс",
            "main_genre": "Модернизм",
            "sub_genre": "Роман",
            "rating": 4.2,
            "year": 1922,
            "pages": 730,
            "description": "Джеймс Джойс (1882—1941) — великий ирландский писатель, классик и одновременно разрушитель классики с ее канонами, человек, которому более, чем кому-либо, обязаны своим рождением новые литературные школы и направления XX века. Роман «Улисс» (1922) — главное произведение писателя, определившее пути развития искусства прозы и не раз признанное лучшим, значительнейшим романом за всю историю этого жанра.\
            По замыслу автора, «Улисс» — рассказ об одном дне, прожитом одним обывателем из одного некрупного европейского городка, — вместил в себя всю литературу со всеми ее стилями и техниками письма и выразил все, что искусство способно сказать о человеке.",
            "cover_image": f"{base_image_path}book_17.jpg",
            "tags": ["Дублин", "один день", "сознание", "сложный"],
            "character_age": "30-40",
            "character_gender": "мужчина",
            "character_profession": "агент по рекламе",
            "setting_time_period": "1900-е года",
            "setting_location": "Дублин",
            "setting_type": "город",
            "plot_tropes": ["один день жизни", "аллюзии"],
            "mood": ["абсурдное", "рефлексивное"],
            "pacing": "медленный",
            "themes": ["обыденность", "память", "искусство"],
            "style": ["поток сознания", "экспериментальный"]
        },
        {
            "id": 18,
            "title": "Шерлок Холмс. Собака Баскервилей",
            "author": "Артур Конан Дойл",
            "main_genre": "Детектив",
            "sub_genre": "Классический детектив",
            "rating": 4.8,
            "year": 1902,
            "pages": 256,
            "description": "Английский врач и писатель сэр Артур Конан Дойль известен всему миру как непревзойденный мастер детективного жанра, автор множества произведений о гениальном сыщике Шерлоке Холмсе и его верном друге докторе Ватсоне. Классические переводы этих рассказов и романов, делавшиеся давно и множеством разных переводчиков, страдают известными недостатками: расхождения, пропуски, откровенные ошибки. Вашему вниманию предлагается заключительный том (роман «Собака Баскервилей», сборники «Его прощальный поклон» и «Архив Шерлока Холмса») из давно готовившегося четырехтомника с полным переводом всего холмсовского канона. Это воистину уникальное издание: все произведения цикла переведены заново Людмилой Бриловой и Сергеем Сухаревым — мастерами, чьи переводы Кадзуо Исигуро и Рэя Брэдбери, Фрэнсиса Скотта Фицджеральда и Чарльза Паллисера, Томаса Де Квинси, Германа Мелвилла и других давно стали классическими. При этом в каждый том включено множество дополнительных материалов: предисловия к ранним публикациям, воспоминания Конан Дойля, касающиеся тех или иных произведений, некоторые интервью писателя. Плюс каждый том снабжен обширнейшими комментариями и богато иллюстрирован лучшими классическими рисунками.\
            В данную книгу включен полный комплект иллюстраций, сопровождавших исходную публикацию в журнале «Стрэнд» романа «Собака Баскервилей» и всех рассказов из обоих сборников, — иллюстраций Сидни Пэджета, Уолтера Пэджета, Гилберта Холидея и других художников.",
            "cover_image": f"{base_image_path}book_18.jpg",
            "tags": ["Холмс", "расследование", "призрак", "деревня"],
            "character_age": "40-50",
            "character_gender": "мужчина",
            "character_profession": "детектив",
            "setting_time_period": "Викторианская эпоха",
            "setting_location": "Англия",
            "setting_type": "сельская местность",
            "plot_tropes": ["семейное проклятие", "расследование"],
            "mood": ["загадочное", "готическое"],
            "pacing": "средний",
            "themes": ["логика против суеверий", "наследство"],
            "style": ["классический", "атмосферный"]
        },
        {
            "id": 19,
            "title": "Колыбель для кошки",
            "author": "Курт Воннегут",
            "main_genre": "Научная фантастика",
            "sub_genre": "Сатира",
            "rating": 4.4,
            "year": 1963,
            "pages": 288,
            "description": "Послушайте — когда-то, две жены тому назад, двести пятьдесят тысяч сигарет тому назад, три тысячи литров спиртного назад… Тогда, когда все были молоды… Послушайте — мир вращался, богатые изнывали от глупости и скуки, бедным оставалось одно — быть СВОБОДНЫМИ и УМНЫМИ. Правда была неправдоподобнее всякого вымысла. Женщины были злы и красивы, а мужчины — несчастны и полны глупых надежд. И крутилась, крутилась жизнь, запутывалась все сильнее — как дикая, странная игра под названием «КОЛЫБЕЛЬ ДЛЯ КОШКИ»…",
            "cover_image": f"{base_image_path}book_19.jpg",
            "tags": ["сатира", "конец света", "наука", "религия"],
            "character_age": "30-40",
            "character_gender": "мужчина",
            "character_profession": "журналист",
            "setting_time_period": "Холодная война",
            "setting_location": "Вымышленная страна",
            "setting_type": "островное государство",
            "plot_tropes": ["опасное изобретение", "сатира на общество"],
            "mood": ["ироничное", "циничное", "абсурдное"],
            "pacing": "быстрый",
            "themes": ["наука и мораль", "религия", "абсурд войны"],
            "style": ["сатирический", "черный юмор"]
        },
        {
            "id": 20,
            "title": "Атлант расправил плечи",
            "author": "Айн Рэнд",
            "main_genre": "Философский роман",
            "sub_genre": "Антиутопия",
            "rating": 4.5,
            "year": 1957,
            "pages": 1168,
            "description": "К власти в США приходят социалисты и правительство берет курс на «равные возможности», считая справедливым за счет талантливых и состоятельных сделать богатыми никчемных и бесталанных.\
            Гонения на бизнес приводят к разрушению экономики, к тому же один за другим при загадочных обстоятельствах начинают исчезать талантливые люди и лучшие предприниматели.\
            Главные герои романа стальной король Хэнк Риарден и вице-президент железнодорожной компании Дагни Таггерт тщетно пытаются противостоять трагическим событиям. Вместо всеобщего процветания общество погружается в апатию и хаос.",
            "cover_image": f"{base_image_path}book_20.jpg",
            "tags": ["капитализм", "индивидуализм", "забастовка", "антиутопия", "бизнес"],
            "character_age": "30-40",
            "character_gender": "оба пола",
            "character_profession": "промышленники",
            "setting_time_period": "1950-е годы",
            "setting_location": "США",
            "setting_type": "индустриальное",
            "plot_tropes": ["забастовка гениев", "крушение системы"],
            "mood": ["дидактическое", "интеллектуальное"],
            "pacing": "медленный",
            "themes": ["индивидуализм", "разум", "свобода"],
            "style": ["риторический", "идейный"]
        },
        {
            "id": 21,
            "title": "Тайна Эдвина Друда",
            "author": "Чарльз Диккенс",
            "main_genre": "Детектив",
            "sub_genre": "Готический детектив",
            "rating": 4.3,
            "year": 1870,
            "pages": 288,
            "description": "Последний, неоконченный роман Диккенса. В тихом соборном городе Клойстерхэм опекун Эдвин Друд и его друг Невил Ландлесс влюблены в одну девушку. Между молодыми людьми вспыхивает ссора, а вскоре Эдвин Друд таинственно исчезает в бурную рождественскую ночь. Город полнится слухами о проклятии, тяготеющем над семьей Друдов, а местный чудак-священник, мистер Криспаркл, начинает собственное расследование.",
            "cover_image": f"{base_image_path}book_21.jpg",
            "tags": ["неоконченный роман", "проклятие", "соборный город", "исчезновение"],
            "character_age": "20-30",
            "character_gender": "мужчина",
            "character_profession": "аристократ",
            "setting_time_period": "Викторианская эпоха",
            "setting_location": "Англия",
            "setting_type": "город",
            "plot_tropes": ["семейное проклятие", "таинственное исчезновение", "неоконченный роман"],
            "mood": ["загадочное", "мрачное", "готическое"],
            "pacing": "средний",
            "themes": ["тайна", "религия", "фатум"],
            "style": ["классический", "незавершенный"]
    },
    {
            "id": 22,
            "title": "Падение дома Ашеров",
            "author": "Эдгар Аллан По",
            "main_genre": "Ужасы",
            "sub_genre": "Готическая проза",
            "rating": 4.6,
            "year": 1839,
            "pages": 64,
            "description": "Рассказ о роковой болезни леди Мадлен и её брата Родерика Ашера, последних отпрысков древнего и угасающего рода. Наследственная болезнь — лишь внешнее проявление глубокого духовного и физического вырождения, настоящего проклятия, тяготеющего над семьей и её мрачным родовым поместьем. Друг детства Родерика становится свидетелем ужасающей кульминации этого проклятия.",
            "cover_image": f"{base_image_path}book_22.jpg",
            "tags": ["готика", "ужасы", "проклятие", "вырождение", "поместье"],
            "character_age": "30-40",
            "character_gender": "мужчина",
            "character_profession": "аристократ",
            "setting_time_period": "Викторианская эпоха",
            "setting_location": "Англия",
            "setting_type": "замок/поместье",
            "plot_tropes": ["семейное проклятие", "вырождение рода", "живой дом"],
            "mood": ["гнетущее", "декадентское", "ужасающее"],
            "pacing": "нарастающий",
            "themes": ["безумие", "смерть", "изоляция", "наследственность"],
            "style": ["поэтичный", "атмосферный", "мрачный"]
        }   
    ]
    
        return pd.DataFrame(books_data)
    
    def _create_sample_reviews(self) -> pd.DataFrame:
        """Создание демонстрационных отзывов"""
        reviews_data = [
            {
                "id": 1,
                "book_id": 1,
                "username": "Читатель_1",
                "rating": 5,
                "text": "Уютная и вдохновляющая книга! Идеально для вечернего чтения.",
                "created_at": "2023-10-15",
                "likes": 12
            },
            {
                "id": 2,
                "book_id": 2,
                "username": "Любитель_фэнтези",
                "rating": 4,
                "text": "Отличное сочетание исторического детектива и фэнтези.",
                "created_at": "2023-09-20",
                "likes": 8
            }
        ]
        return pd.DataFrame(reviews_data)
    
    def get_filter_options(self) -> Dict:
        """Получение всех доступных опций для фильтрации"""
        books_df = self.books
        
        return {
            "main_genres": sorted(books_df["main_genre"].unique()),
            "sub_genres": sorted(books_df["sub_genre"].dropna().unique()),
            "character_ages": sorted(books_df["character_age"].dropna().unique()),
            "character_professions": sorted(books_df["character_profession"].dropna().unique()),
            "settings": sorted(books_df["setting_location"].dropna().unique()),
            "time_periods": sorted(books_df["setting_time_period"].dropna().unique()),
            "moods": sorted(set([m for moods in books_df["mood"] for m in moods])),
            "tropes": sorted(set([t for tropes in books_df["plot_tropes"] for t in tropes]))
        }
    
    def get_reviews_for_user(self, username: str) -> pd.DataFrame:
        """Получение отзывов пользователя"""
        return self.reviews[self.reviews["username"] == username]